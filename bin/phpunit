#!/bin/bash
# strict mode http://redsymbol.net/articles/unofficial-bash-strict-mode/
set -euo pipefail

# Source all the configuration environment variables from the docker-compose
# .env file.
dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
. ${dir}/source_config

if ! type docker > /dev/null; then
  echo "Docker is required to be present on $PATH"
  exit 0
fi

if [[ "${CI:-}" ]] ; then
  image="${DOCKER_IMAGE}_cli"
  vol="${PWD}/docker/conf/drupal/settings.php:/var/www/html/sites/default/settings.php"
  vol2="-v ${PWD}/docker/conf/phpunit.xml:/var/www/html/core/phpunit.xml"
else
  image="${DOCKER_IMAGE}_cli"
  vol="${PWD}:/var/www"
fi

docker run -i \
  --entrypoint=/var/www/vendor/bin/phpunit \
  -v $vol \
  $vol2 \
  -v /tmp/:/tmp/ \
  -w "/var/www/html" \
  -e "SIMPLETEST_DB=mysql://root:root@db:3306/${DB_NAME}" \
  --sig-proxy=true \
  --pid=host \
  --net "${DOCKER_IMAGE}_default" \
  --rm \
  "${image}" "$@"
